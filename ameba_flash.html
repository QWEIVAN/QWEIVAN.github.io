<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Ameba D Flasher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .log-window::-webkit-scrollbar { width: 8px; }
        .log-window::-webkit-scrollbar-track { background: #1f2937; }
        .log-window::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .log-window::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-4 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400"><i class="fas fa-microchip mr-2"></i>AmebaD Web Flasher</h1>
                <p class="text-gray-400 text-sm mt-1">For Realtek AmebaD (BW16/RTL8720)</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center bg-gray-800 rounded px-3 py-2 border border-gray-700">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="useEmbedded" class="sr-only peer" checked onchange="toggleMode()">
                        <div class="relative w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        <span class="ms-3 text-sm font-medium text-gray-300">Simple Mode</span>
                    </label>
                </div>
                <select id="baudRate" class="bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                    <option value="115200">115200 (Safe)</option>
                    <option value="921600">921600 (Fast)</option>
                    <option value="1500000" selected>1500000 (Turbo)</option>
                </select>
                <button id="connectBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-semibold transition flex items-center whitespace-nowrap">
                    <i class="fas fa-plug mr-2"></i> Connect
                </button>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Controls -->
            <div class="lg:col-span-2 space-y-6">

                <!-- SIMPLE MODE CARD -->
                <div id="simpleModeCard" class="bg-gray-800 p-5 rounded-lg border border-blue-500/30 shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-blue-600 text-xs font-bold px-2 py-1 rounded-bl">RECOMMENDED</div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-blue-400">1. Application Firmware</h2>
                    </div>
                    <p class="text-gray-400 text-xs mb-3">
                        Select your <code>km0_km4_image2.bin</code>. Bootloaders and Flashloader are embedded and will be flashed automatically.
                    </p>
                    <div class="flex space-x-2">
                        <input type="text" value="0x8006000" disabled class="bg-gray-900 border border-gray-600 text-gray-500 rounded px-3 py-2 w-32 font-mono text-sm">
                        <input type="file" id="simpleAppFile" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-900 file:text-blue-300 hover:file:bg-blue-800 cursor-pointer bg-gray-900 border border-gray-600 rounded">
                    </div>
                </div>

                <!-- ADVANCED MODE: Flashloader -->
                <div id="flashLoaderCard" class="bg-gray-800 p-5 rounded-lg border border-gray-700 shadow-lg hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-green-400">1. System Flashloader (RAM)</h2>
                        <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Required</span>
                    </div>
                    <p class="text-gray-400 text-xs mb-3">
                        The Ameba chip requires a helper binary to be loaded into RAM (0x082000).
                    </p>
                    <div class="flex space-x-2">
                        <input type="text" value="0x082000" disabled class="bg-gray-900 border border-gray-600 text-gray-500 rounded px-3 py-2 w-32 font-mono text-sm">
                        <input type="file" id="flashLoaderFile" onchange="logBase64(this, 'FLASHLOADER')" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-green-900 file:text-green-300 hover:file:bg-green-800 cursor-pointer bg-gray-900 border border-gray-600 rounded">
                    </div>
                </div>

                <!-- ADVANCED MODE: Files -->
                <div id="fileListCard" class="bg-gray-800 p-5 rounded-lg border border-gray-700 shadow-lg hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-blue-400">2. Firmware Images</h2>
                        <button onclick="addFileRow()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">
                            <i class="fas fa-plus"></i> Add Row
                        </button>
                    </div>
                    
                    <div id="fileList" class="space-y-3">
                        <!-- Default Row: KM0 Boot -->
                        <div class="file-row flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 items-start md:items-center bg-gray-900 p-2 rounded border border-gray-700">
                            <div class="w-full md:w-auto">
                                <label class="block text-xs text-gray-500 mb-1">Address (Hex)</label>
                                <input type="text" value="0x8000000" class="addr-input bg-gray-800 border border-gray-600 text-white rounded px-3 py-2 w-32 font-mono text-sm focus:border-blue-500 focus:outline-none" placeholder="0x...">
                            </div>
                            <div class="flex-1 w-full">
                                <label class="block text-xs text-gray-500 mb-1">Binary File</label>
                                <input type="file" onchange="logBase64(this, 'KM0')" class="file-input block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-900 file:text-blue-300 hover:file:bg-blue-800 cursor-pointer">
                            </div>
                            <button onclick="removeRow(this)" class="text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash"></i></button>
                        </div>

                         <!-- Default Row: KM4 Boot -->
                         <div class="file-row flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 items-start md:items-center bg-gray-900 p-2 rounded border border-gray-700">
                            <div class="w-full md:w-auto">
                                <label class="block text-xs text-gray-500 mb-1">Address (Hex)</label>
                                <input type="text" value="0x8004000" class="addr-input bg-gray-800 border border-gray-600 text-white rounded px-3 py-2 w-32 font-mono text-sm focus:border-blue-500 focus:outline-none" placeholder="0x...">
                            </div>
                            <div class="flex-1 w-full">
                                <label class="block text-xs text-gray-500 mb-1">Binary File</label>
                                <input type="file" onchange="logBase64(this, 'KM4')" class="file-input block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-900 file:text-blue-300 hover:file:bg-blue-800 cursor-pointer">
                            </div>
                            <button onclick="removeRow(this)" class="text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                         <!-- Default Row: App -->
                         <div class="file-row flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 items-start md:items-center bg-gray-900 p-2 rounded border border-gray-700">
                            <div class="w-full md:w-auto">
                                <label class="block text-xs text-gray-500 mb-1">Address (Hex)</label>
                                <input type="text" value="0x8006000" class="addr-input bg-gray-800 border border-gray-600 text-white rounded px-3 py-2 w-32 font-mono text-sm focus:border-blue-500 focus:outline-none" placeholder="0x...">
                            </div>
                            <div class="flex-1 w-full">
                                <label class="block text-xs text-gray-500 mb-1">Binary File</label>
                                <input type="file" class="file-input block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-900 file:text-blue-300 hover:file:bg-blue-800 cursor-pointer">
                            </div>
                            <button onclick="removeRow(this)" class="text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="flashBtn" disabled class="bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-white py-4 rounded-lg font-bold text-lg shadow-lg transition transform active:scale-95">
                        START FLASHING
                    </button>
                    <button id="eraseBtn" disabled class="bg-red-600 hover:bg-red-500 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-white py-4 rounded-lg font-bold text-lg shadow-lg transition transform active:scale-95">
                        ERASE CHIP
                    </button>
                </div>
            </div>

            <!-- Right Column: Logs & Progress -->
            <div class="lg:col-span-1 flex flex-col bg-gray-800 rounded-lg border border-gray-700 shadow-lg p-4">
                <h3 class="text-gray-400 text-sm font-semibold mb-2 uppercase tracking-wide">Operation Log</h3>
                <div id="logArea" class="log-window bg-gray-950 font-mono text-xs p-3 rounded overflow-y-auto whitespace-pre-wrap text-green-400 h-[500px]"> > Waiting for device connection...</div>
                
                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span id="progressText">Idle</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="progressBar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
const EMBEDDED_FIRMWARE = {
    FLASHLOADER: "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JyCaGAaSqEcGqxgARvKNIwQhwPIAA5hHlOVHRk1GVEaQ5QC/8LXeRk5GRUZXRkPyVCPgtcDyCAOLsAWTRPLVM8DyAAMHk0TysQPA8gADBpNB8sNDwPIAAwKTRvJ1I8DyAANA8mBrAZND8lAjwPIIC8DyCANG8lEmRvIhJQiTW0YEkMDyAAbA8gAFCZMBIgWbCZyagAAi2mAjaAohA5MYAAebmEcjaASZGAADkwabmEf/9wz6AOCwR6hHACj70f/3Lf0CIAAh//cb+jNI//cC/QQo9tBW2QUoD9AIKAHQU+CwR6hHACj70QKbQPLoMJhHFSABm5hH5OewR6hHACj70b/zT4+/82+PTvYAVEDyUCPO8gAE4FC/80+Pv/Nvj807/zvgUL/zT48EO+NYtEbaBBsBWwySDVsBmEbTB5tGKwBD9uB6RUZA8mAnFgCYRlBGWkYzAChAAQARQ+FRgCEJBolGSkQBO/bSID0rACAz7tFmRkVGv/NPj7/zb48AIgibGmCD5wEonNACm0Dy6DCYRxggAZuYR7DnWDIIAAEgcEdB8lVDELVA8gAhACDA8gADmEe/80+PTvYAUwQizvIAA8Dy+lLaYL/zT4/ARv3nAL9B8pgjGGhDQlhBwLJwRwC/QPL4M8T2AAMZaE/2/3JD8mQjCkDA8ggDELUaYEHymCMbaDOxVCMCIcT2AAMaaApDGmBD8pVTACDA8gADmEcQvVVBUlRJTUdfRG93bmxvYWQgJXgKAAAAAA1VQVJUSU1HX0Rvd25sb2FkIERvbmUgCgAAAABuAAAALAEAAFgCAACwBAAAYAkAAMASAACAJQAAQDgAAABLAACAcAAAAJYAAADhAAAALAEAAMIBAAD0AQAAWAIAAIQDAPDNBQAACAcAIKEHAAAQDgBAQg8AABgVADAKFgBg4xYAACAcAICEHgAgCyAAADAqAMDGLQBQlzEADFc4AHA4OQAACT0AgI1bAP////8NeE1vZGVtOiBXYWl0IE5leHQgRnJhbWUgU3RhcnQgVGltZW91dA0KAAAAAA14TW9kZW06IEdldCBDYW5jZWwNCgAAAA14TW9kZW06IEVuZCBvZiBUcmFuc21pdA0KAAANeE1vZGVtOiBBYm9ydGVkIQ0KAA14TW9kZW1HZXRPdGhlcnMgVGltZW91dCAjMQ0KAAAADXhNb2RlbUdldE90aGVycyBUaW1lb3V0ICMyDQoAAAANSW5jb3JyZWN0IEZyYW1lTm8gJXggJXgNCgAADVdyb25nIEZyYW1lTm86IGV4cGVjdCBmb3IgMHgleCBidXQgZ290IDB4JXgNCgAADXhNb2RlbUdldE90aGVycyBUaW1lb3V0ICMzDQoAAAANeE1vZGVtR2V0T3RoZXJzIFRpbWVvdXQgIzQNCgAAAA1DaGVjay1TdW0gRXJyKCV4ICV4KSENCgAAAAA=",
    KM0: "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CgAAAFtNT0RVTEVfQk9PVC1MRVZFTF9JTkZPXTpJTUcxIEVOVEVSIFJPTVNVQjolZAoAAFtNT0RVTEVfQk9PVC1MRVZFTF9JTkZPXTpHUElPIGZvcmNlIE9UQTEgCgAAW01PRFVMRV9CT09ULUxFVkVMX0lORk9dOk9UQTIgVVNFCgAAW01PRFVMRV9CT09ULUxFVkVMX0lORk9dOk9UQTEgVVNFCgAAW01PRFVMRV9CT09ULUxFVkVMX0VSUk9SXTpJTUcyIEludmFsaWQKAFtNT0RVTEVfQk9PVC1MRVZFTF9JTkZPXTpJTUcyIERBVEFbMHgleDolZDoweCV4XQoAAABbTU9EVUxFX0JPT1QtTEVWRUxfRVJST1JdOklNRzIgQUREUiBJbnZhbGlkCgAAAABbTU9EVUxFX0JPT1QtTEVWRUxfSU5GT106SU1HMiBTSUdOWyVzKCV4KV0KAFtNT0RVTEVfQk9PVC1MRVZFTF9JTkZPXTpJTUcyIEVOVFJZWzB4JXg6MHgleF0KAFJUS1dpbgAAW01PRFVMRV9CT09ULUxFVkVMX0VSUk9SXTpJTUcyIFNJR04gSW52YWxpZAoAAAAADUlNRzEgRU5URVIgUkFNCgAAAAANSU1HMiBTSUdOWyVzXSwgU1RBUlRbMHglMDh4XSAKAA1JbnZhbGlkIEltYWdlMiBTaWduYXR1cmUKAAAIAgBIAf///wAAAAAAAAAQgAIASAH///8AAAAAAwAAAAAAAAAD////AAAAAAQAAACAAgBIAf///wAAAAAEAAAAsAIASAH///8AAAAAAAAAgAAAAAAD////AAAAAAQAAABkAgBIAf///wAAACAAAAAAsAIASAH///8AAAAAAAAAYAACAEgB////AAAgAAAAAAD0AwBIAv///wAQAAAAEAAAsAIASAH///8AAAAAAAEAAP//////////AAAAAAAAAAAAAAAAAAAAAAD/AAAAIAAIAgAAAP//////AAAA//////8AAAD//////wAAAP//////AAAAAGAACABgEAj/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////",
    KM4: "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RUxfSU5GT106UkRQIEVOCgAAAAANDQpIYXJkIEZhdWx0IFBhdGNoIChTZWN1cmUpDQoAAA1JTUcyIFNCT09UIE9GRgoAAAAADUlNRzIgU0JPT1QgT0sKAA1JTUcyIFNCT09UIEZBSUwKAAAAW01PRFVMRV9CT09ULUxFVkVMX0lORk9dOklNRzEgRU5URVIgTVNQOlslMDh4XQoAW01PRFVMRV9CT09ULUxFVkVMX0VSUk9SXTpJTUcyIFNJWkUgSW52YWxpZAoAAAAAW01PRFVMRV9CT09ULUxFVkVMX0lORk9dOklNRzIgREFUQVsweCV4OiVkOjB4JXhdCgAAAFtNT0RVTEVfQk9PVC1MRVZFTF9FUlJPUl06SU1HMiBBRERSIEludmFsaWQKAAAAAFtNT0RVTEVfQk9PVC1MRVZFTF9JTkZPXTpJTUcyIFNJR05bJXMoJXgpXQoAW01PRFVMRV9CT09ULUxFVkVMX0lORk9dOklNRzIgRU5UUllbMHgleDoweCV4XQoAUlRLV2luAABbTU9EVUxFX0JPT1QtTEVWRUxfRVJST1JdOklNRzIgU0lHTiBJbnZhbGlkCgAAAABbTU9EVUxFX0JPT1QtTEVWRUxfSU5GT106U3RhcnQgTm9uU2VjdXJlIEAgMHgleCAuLi4NCgAAAA1JTUcxIEVOVEVSIFJBTQoAAAAADUlNRzIgU0lHTlslc10sIFNUQVJUWzB4JTA4eF0gCgANSW52YWxpZCBJbWFnZTIgU2lnbmF0dXJlCgAAAAAAAAAAAAAA/wAAACAACAIAAAD//////wAAAP//////AAAA//////8AAAD//////wAAAABgAAgAYBAI/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////wAAAED///9PAAAAAACgEBD/Px0QAAAAAAAADhD//w8QAAAAAAAAAAD/vwcQAAAAAP//////////AAAAAP//////////AAAAAP//////////AAAAAP//////////AAAAAA=="
};

const RET_SUCCESS = 0x06;
const RET_SYNC = 0x15;
const RAM_LOADER_ADDR = 0x082000;

const SPEED_MAP = {
    1500000: 0x18, 1444400: 0x17, 1382400: 0x16, 1000000: 0x15,
    921600:  0x14, 500000:  0x13, 460800:  0x12, 380400:  0x11,
    230400:  0x10, 153600:  0x0F, 128000:  0x0D, 115200:  0x0C
};

let port = null;
let writer = null;
let reader = null;
let keepReading = false;
let inputChunks = []; 
let inputBufferTotalLen = 0;

const connectBtn = document.getElementById('connectBtn');
const flashBtn = document.getElementById('flashBtn');
const eraseBtn = document.getElementById('eraseBtn');
const logArea = document.getElementById('logArea');
const progressBar = document.getElementById('progressBar');
const progressPercent = document.getElementById('progressPercent');
const progressText = document.getElementById('progressText');
const useEmbeddedToggle = document.getElementById('useEmbedded');

function base64ToUint8Array(base64) {
    if (!base64) return null;
    const binary_string = window.atob(base64);
    const len = binary_string.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes;
}

async function logBase64(input, label) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            // Extract Base64 part (remove data:application/octet-stream;base64,)
            const base64 = e.target.result.split(',')[1];
            console.log(`%c[BASE64 for ${label}] Copy line below:`, 'color: cyan; font-weight: bold;');
            console.log(base64);
        };
        reader.readAsDataURL(file);
    }
}

function toggleMode() {
    const isSimple = useEmbeddedToggle.checked;
    const simpleCard = document.getElementById('simpleModeCard');
    const flashLoaderCard = document.getElementById('flashLoaderCard');
    const fileListCard = document.getElementById('fileListCard');

    if (isSimple) {
        simpleCard.classList.remove('hidden');
        flashLoaderCard.classList.add('hidden');
        fileListCard.classList.add('hidden');
    } else {
        simpleCard.classList.add('hidden');
        flashLoaderCard.classList.remove('hidden');
        fileListCard.classList.remove('hidden');
    }
}

toggleMode();

function log(msg, isError = false) {
    const timestamp = new Date().toLocaleTimeString();
    const span = document.createElement('span');
    span.textContent = `[${timestamp}] ${msg}\n`;
    if (isError) span.classList.add('text-red-400');
    logArea.appendChild(span);
    logArea.scrollTop = logArea.scrollHeight;
}

function setProgress(percent, status) {
    progressBar.style.width = `${percent}%`;
    progressPercent.textContent = `${Math.floor(percent)}%`;
    if (status) progressText.textContent = status;
}

async function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function readLoop() {
    keepReading = true;
    while (port && port.readable && keepReading) {
        try {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
                inputChunks.push(value);
                inputBufferTotalLen += value.length;
                if (inputBufferTotalLen > 2000000) {
                    const remove = inputChunks.shift();
                    inputBufferTotalLen -= remove.length;
                }
            }
        } catch (error) { break; }
    }
}

async function readBytes(count, timeoutMs = 2000) {
    const startTime = Date.now();
    while (inputBufferTotalLen < count) {
        if (Date.now() - startTime > timeoutMs) throw new Error("Read timeout");
        await sleep(5);
    }
    const ret = new Uint8Array(count);
    let offset = 0;
    while (offset < count) {
        const chunk = inputChunks[0];
        const needed = count - offset;
        if (chunk.length <= needed) {
            ret.set(chunk, offset);
            offset += chunk.length;
            inputBufferTotalLen -= chunk.length;
            inputChunks.shift();
        } else {
            ret.set(chunk.slice(0, needed), offset);
            inputChunks[0] = chunk.slice(needed);
            inputBufferTotalLen -= needed;
            offset += needed;
        }
    }
    return ret;
}

async function readOneByte(timeoutMs = 1000) {
    const buf = await readBytes(1, timeoutMs);
    return buf[0];
}

async function flushBuffer() {
    inputChunks = [];
    inputBufferTotalLen = 0;
}

async function resetToFlashMode() {
    if (!port) return;
    log("Resetting to Flash Mode (DTR/RTS)...");
    await port.setSignals({ requestToSend: true, dataTerminalReady: false });
    await sleep(500);
    await port.setSignals({ requestToSend: false, dataTerminalReady: true });
    await sleep(200);
    await port.setSignals({ requestToSend: false, dataTerminalReady: false });
    await sleep(500);
}

async function resetToBoot() {
    if (!port) return;
    log("Resetting to Boot Mode...");
    await port.setSignals({ requestToSend: true, dataTerminalReady: false });
    await sleep(500);
    await port.setSignals({ requestToSend: false, dataTerminalReady: false });
}

async function waitForSync(length, attempts = 500) {
    let found = 0;
    while (found < length && attempts > 0) {
        try {
            const b = await readOneByte(50);
            if (b === RET_SYNC) found++;
        } catch (e) {}
        attempts--;
    }
    return found === length;
}

async function sendCmd(cmdBuf) {
    if (cmdBuf[0] !== 0x07) {
        if (!await waitForSync(1, 20)) {} 
    }
    await writer.write(cmdBuf);
    const start = Date.now();
    while (Date.now() - start < 5000) {
        try {
            const b = await readOneByte(200);
            if (b === RET_SUCCESS) return true;
            if (b === RET_SYNC) continue; 
        } catch(e) {}
    }
    return false;
}

function calcPacketChecksum(data) {
    let sum = 0;
    for (let b of data) sum += b;
    return (0xFF + sum) & 0xFF;
}

async function writeBlock(addr, data, prefix, startPercent, endPercent, startSeqId) {
    const size = data.length;
    const numPackets = Math.ceil(size / 1024);
    log(`Writing ${size} bytes to 0x${addr.toString(16)}...`);
    if (!await waitForSync(1)) throw new Error("Sync timeout before writing block");
    let seqId = startSeqId;
    for (let i = 0; i < numPackets; i++) {
        const chunkStart = i * 1024;
        const chunkEnd = Math.min(chunkStart + 1024, size);
        const chunk = data.slice(chunkStart, chunkEnd);
        const packet = new Uint8Array(1032);
        const view = new DataView(packet.buffer);
        const currentAddr = addr + chunkStart;
        const currentSeq = (seqId + i) & 0xFF;
        packet[0] = 0x02;
        packet[1] = currentSeq;
        packet[2] = (~currentSeq) & 0xFF;
        view.setUint32(3, currentAddr, true); 
        packet.set(chunk, 7);
        if (chunk.length < 1024) packet.fill(0xFF, 7 + chunk.length, 1031); 
        packet[1031] = calcPacketChecksum(packet.slice(0, 1031));
        let retries = 0;
        let success = false;
        while (!success && retries < 10) {
            await writer.write(packet);
            try {
                const b = await readOneByte(500);
                if (b === RET_SUCCESS) success = true;
            } catch (e) {}
            if(!success) {
                retries++;
                await sleep(50);
            }
        }
        if (!success) throw new Error(`Failed to write packet ${i}`);
        const packetProgress = (i + 1) / numPackets;
        const totalProgress = startPercent + (packetProgress * (endPercent - startPercent));
        setProgress(totalProgress, `${prefix} (${Math.round(packetProgress*100)}%)`);
    }
    return seqId + numPackets; 
}

async function changeBaudRate(targetBaud) {
    if (!SPEED_MAP[targetBaud]) { log(`Baud ${targetBaud} unsupp.`); return; }
    log(`Baud -> ${targetBaud}...`);
    const cmd = new Uint8Array([0x05, SPEED_MAP[targetBaud]]);
    await sendCmd(cmd);
    keepReading = false;
    try { await reader.cancel(); } catch(e) {}
    await writer.close();
    await port.close();
    await sleep(200);
    await port.open({ baudRate: parseInt(targetBaud) });
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    flushBuffer();
    readLoop();
    if (!await sendCmd(new Uint8Array([0x07]))) throw new Error("Baud confirm failed");
    if (!await waitForSync(1)) throw new Error("Sync post-baud failed");
    log("Baud OK.");
}

async function runOperation(mode) {
    try {
        if (!port) { alert("Please connect!"); return; }
        
        const isSimple = useEmbeddedToggle.checked;
        let operations = [];
        let loaderData = null;

        if (isSimple) {
            
            if (!EMBEDDED_FIRMWARE.FLASHLOADER || !EMBEDDED_FIRMWARE.KM0 || !EMBEDDED_FIRMWARE.KM4) {
                throw new Error("Embedded firmware missing! Please populate EMBEDDED_FIRMWARE in code or use Advanced Mode.");
            }

            loaderData = base64ToUint8Array(EMBEDDED_FIRMWARE.FLASHLOADER);
            
            operations.push({ addr: 0x8000000, data: base64ToUint8Array(EMBEDDED_FIRMWARE.KM0), name: "KM0 Boot" });
            operations.push({ addr: 0x8004000, data: base64ToUint8Array(EMBEDDED_FIRMWARE.KM4), name: "KM4 Boot" });
            
            const appInput = document.getElementById('simpleAppFile');//cancro29
            if (!appInput.files[0]) throw new Error("Please select Application Firmware.");
            operations.push({ addr: 0x8006000, data: new Uint8Array(await appInput.files[0].arrayBuffer()), name: "User App" });

        } else {
            const flashLoaderInput = document.getElementById('flashLoaderFile');
            if (!flashLoaderInput.files[0]) throw new Error("Flashloader file required in Advanced Mode.");
            loaderData = new Uint8Array(await flashLoaderInput.files[0].arrayBuffer());

            const rows = document.querySelectorAll('.file-row');
            for (let row of rows) {
                const addrStr = row.querySelector('.addr-input').value;
                const fileInput = row.querySelector('.file-input').files[0];
                if (fileInput) {
                    operations.push({
                        addr: parseInt(addrStr, 16),
                        data: new Uint8Array(await fileInput.arrayBuffer()),
                        name: fileInput.name
                    });
                }
            }
            if (operations.length === 0) throw new Error("No firmware files selected.");
        }

        logArea.textContent = ''; 
        log(`Starting Operation (${isSimple ? 'Simple' : 'Advanced'})...`);
        flashBtn.disabled = true;
        eraseBtn.disabled = true;
        
        setProgress(5, "Entering Flash Mode...");
        await resetToFlashMode();
        await flushBuffer(); 

        if (!await waitForSync(2, 50)) {
            throw new Error("Handshake failed. Check wiring/Manual Reset.");
        }
        log("Handshake OK.");

        const targetBaud = document.getElementById('baudRate').value;
        if (targetBaud != 115200) await changeBaudRate(targetBaud);

        await writeBlock(RAM_LOADER_ADDR, loaderData, "Load Flashloader", 10, 30, 1);
        
        log("Executing Flashloader...");
        if (!await waitForSync(1)) throw new Error("Sync before Exec timeout"); 
        await sendCmd(new Uint8Array([0x04]));
        await sleep(500);

        log("Re-init @ 115200...");
        keepReading = false;
        try { await reader.cancel(); } catch(e) {}
        await writer.close();
        await port.close();
        await sleep(100);
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        reader = port.readable.getReader();
        flushBuffer();
        readLoop();

        if (!await waitForSync(2)) throw new Error("Flashloader Sync failed");
        
        if (mode === 'ERASE') {
             setProgress(50, "Erasing...");
             await sendCmd(new Uint8Array([0x26, 0x01, 0x01, 0x00]));
             
             const eraseAddr = 0x300000;
             const eraseSize = 0xB8000;
             const numSectors = Math.floor((eraseSize + 4095) / 4096);
             const cmdBuf = new Uint8Array(6);
             const view = new DataView(cmdBuf.buffer);
             cmdBuf[0] = 0x17;
             view.setUint32(1, eraseAddr, true);
             cmdBuf[5] = numSectors & 0xFF; 
             
             log(`Erase Cmd: Start=0x${eraseAddr.toString(16)}, Count=${numSectors}`);
             if (!await waitForSync(1)) throw new Error("Sync timeout"); 
             await writer.write(cmdBuf);
             
             let success = false;
             for(let i=0; i<3500; i++) { 
                 try {
                    const b = await readOneByte(100);
                    if (b === RET_SUCCESS) { success = true; break; }
                 } catch(e) {}
                 if(i%10 === 0) setProgress(50 + (i/70), "Erasing...");
             }
             if (!success) throw new Error("Erase Timeout");
             log("Erase Complete.");
        } else {
            log("--- Erase Phase (115200) ---");
            await sendCmd(new Uint8Array([0x26, 0x01, 0x01, 0x00]));

            let currentProgress = 30;
            const progressStep = 20 / operations.length;

            for (let op of operations) {
                const sectors = Math.floor((op.data.length + 4095) / 4096);
                const eraseCmd = new Uint8Array(6);
                const view = new DataView(eraseCmd.buffer);
                eraseCmd[0] = 0x17;
                view.setUint32(1, op.addr, true);
                eraseCmd[5] = sectors & 0xFF;
                
                log(`Erasing ${op.name}...`);
                if (!await waitForSync(1)) throw new Error("Sync timeout"); 
                await writer.write(eraseCmd);
                
                let eSuccess = false;
                for(let i=0; i<500; i++) {
                     try {
                        const b = await readOneByte(100);
                        if (b === RET_SUCCESS) { eSuccess = true; break; }
                     } catch(e) {}
                }
                if (!eSuccess) throw new Error(`Erase failed ${op.name}`);
                currentProgress += progressStep;
                setProgress(currentProgress, `Erased ${op.name}`);
            }

            if (targetBaud != 115200) {
                log("--- Switch High Speed ---");
                await changeBaudRate(targetBaud);
            }

            log("--- Write Phase ---");
            const writeStep = 30 / operations.length;
            
            let globalSeqId = 1; 
            
            for (let op of operations) {
                globalSeqId = await writeBlock(op.addr, op.data, `Flash ${op.name}`, currentProgress, currentProgress + writeStep, globalSeqId);
                currentProgress += writeStep;
            }
        }

        setProgress(100, "Success!");
        log("Done. Resetting...");
        await resetToBoot();

    } catch (err) {
        log(`ERROR: ${err.message}`, true);
        console.error(err);
        setProgress(0, "Failed");
    } finally {
        flashBtn.disabled = false;
        eraseBtn.disabled = false;
        if (port) {
            keepReading = false;
            try { await reader.cancel(); } catch(e) {}
            await writer.close();
            await port.close();
            port = null;
            connectBtn.classList.remove('bg-green-600');
            connectBtn.classList.add('bg-blue-600');
            connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i> Connect Device';
        }
    }
}

connectBtn.addEventListener('click', async () => {
    if (port) {
        keepReading = false;
        if (reader) await reader.cancel();
        if (writer) await writer.close();
        await port.close();
        port = null;
        connectBtn.classList.remove('bg-green-600');
        connectBtn.classList.add('bg-blue-600');
        connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i> Connect Device';
        return;
    }
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        connectBtn.classList.remove('bg-blue-600');
        connectBtn.classList.add('bg-green-600');
        connectBtn.innerHTML = '<i class="fas fa-link mr-2"></i> Connected';
        flashBtn.disabled = false;
        eraseBtn.disabled = false;
        writer = port.writable.getWriter();
        reader = port.readable.getReader();
        flushBuffer();
        readLoop(); 
        log("Connected.");
    } catch (e) { log("Conn Fail: " + e.message, true); }
});

flashBtn.addEventListener('click', () => runOperation('FLASH'));
eraseBtn.addEventListener('click', () => runOperation('ERASE'));

function addFileRow() {
    const container = document.getElementById('fileList');
    const div = document.createElement('div');
    div.className = 'file-row flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 items-start md:items-center bg-gray-900 p-2 rounded border border-gray-700';
    div.innerHTML = `
        <div class="w-full md:w-auto">
            <label class="block text-xs text-gray-500 mb-1">Address (Hex)</label>
            <input type="text" value="0x80XXXXX" class="addr-input bg-gray-800 border border-gray-600 text-white rounded px-3 py-2 w-32 font-mono text-sm focus:border-blue-500 focus:outline-none">
        </div>
        <div class="flex-1 w-full">
            <label class="block text-xs text-gray-500 mb-1">Binary File</label>
            <input type="file" onchange="logBase64(this, 'Custom File')" class="file-input block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-900 file:text-blue-300 hover:file:bg-blue-800 cursor-pointer">
        </div>
        <button onclick="removeRow(this)" class="text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash"></i></button>
    `;
    container.appendChild(div);
}
window.removeRow = function(btn) { btn.closest('.file-row').remove(); }
</script>
</body>
</html>
